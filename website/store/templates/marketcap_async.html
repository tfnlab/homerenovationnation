{% extends 'base.html' %}

{% load custom_filters %}

{% block content %}
<script>
  // Variable to keep track of displayed tokens
  let displayedTokens = new Set();
  // Function to fetch and update data every 3 seconds
  function fetchAndUpdateData() {
    // Define the URL to fetch data from
    const url = "/marketcap_json/";

    // Make a GET request to fetch data
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Fetched data:', data); // Log fetched data for debugging

        // Update token count
        document.getElementById('totalTokenCount').textContent = data.total_token_count;

        // Remove the loading GIF if it exists
        const loadingGif = document.getElementById('loadingGif');
        if (loadingGif) {
          loadingGif.remove();
        }

        // Iterate over each token and append new tokens at the top
        data.tokens.reverse().forEach(token => { // Reverse the array to prepend in order
          // Check if token ID is not in displayedTokens set
          if (!displayedTokens.has(token.id)) {
            const tokenListElement = document.getElementById('tokenList');

            const tokenItem = document.createElement('div');
            tokenItem.className = 'col-md-4 token-item';
            tokenItem.innerHTML = `
              <div class="card">
                <div class="card-body"> 
                  <div>Ticker: <B>${token.symbol}</B>
                    (<a href="/marketcap_async_search/?search_name=symbol&search_value=${token.symbol}" > 
                      <span id="count_${token.mint}_symbol" ><img src="/static/images/load.circle.gif" style="height: 1em;"></span>
                    </a>)
                  </div>
                  <div>${token.mint}
                    (<span id="count_${token.mint}_bundle" ><img src="/static/images/load.circle.gif" style="height: 1em;" alt="Checks if the token has been bundled"></span>)
                  </div>
                  <div>Name: 
                  <a href="javascript:void(0);" onclick="window.open(\'https://www.pump.fun/${token.mint}\', \'newwindow\', \'width=1200, height=2100\'); return false;">${token.name}</a>
                           
                  (
                    <a href="/marketcap_async_search/?search_name=name&search_value=${token.name}" >   
                  <span id="count_${token.mint}_name"><img src="/static/images/load.circle.gif" style="height: 1em;"></span>
                    </a>  
                  )
                  </div>
                  
                  <div>Image URI: 
                    (<a href="/marketcap_async_search/?search_name=image_uri&search_value=${token.image_uri}" > 
                    <span id="count_${token.mint}_image_uri" ><img src="/static/images/load.circle.gif" style="height: 1em;"></span>
                    </a>)
                    <img src="${token.image_uri}" alt="${token.name}" style="width: 100%;"></div>
                    <div>
                      X: ${token.twitter ? (token.twitter.includes('t.me') ? `<a href="${token.twitter}" target="_blank" style="color: red;">${token.twitter.substring(0, 20)}...</a>` : `<a href="${token.twitter}" target="_blank">${token.twitter.substring(0, 20)}...</a>`) : `<span style="color: red;">NONE</span>`}
                      ${token.twitter ? `(<a href="/marketcap_async_search/?search_name=twitter&search_value=${token.twitter}" ><span id="count_${token.mint}_twitter" ><img src="/static/images/load.circle.gif" style="height: 1em;"></span></a>)` : ''}
                    </div>

                    <div>
                      Telegram: ${token.telegram ? (token.telegram.includes('x.com') ? `<a href="${token.telegram}" target="_blank" style="color: red;">${token.telegram.substring(0, 20)}...</a>` : `<a href="${token.telegram}" target="_blank">${token.telegram.substring(0, 20)}...</a>`) : `<span style="color: red;">NONE</span>`}
                      ${token.telegram ? `(<a href="/marketcap_async_search/?search_name=telegram&search_value=${token.telegram}" ><span id="count_${token.mint}_telegram"  >-</span></a>)` : ''}
                    </div>
                  <div>Website: ${token.website ? `<a href="${token.website}" target="_blank">${token.website}</a>` : `<span style="color: red;">NONE</span>`}
                  
                    ${token.website ? `(<a href="/marketcap_async_search/?search_name=website&search_value=${token.website}" ><span id="count_${token.mint}_website" ><img src="/static/images/load.circle.gif" style="height: 1em;"></span></span></a>)` : ''}
                  </div>                  
                  <div>Creator: ${token.creator}
                  (<a href="/marketcap_async_search/?search_name=creator&search_value=${token.creator}" ><span id="count_${token.mint}_creator"  ><img src="/static/images/load.circle.gif" style="height: 1em;"></span></a>)
                  (<span id="count_${token.mint}_creatorbalance" ><img src="/static/images/load.circle.gif" style="height: 1em;"></span>)
                  </div>
                </div>
              </div>
            `;

            // Prepend token item to tokenListElement
            tokenListElement.insertBefore(tokenItem, tokenListElement.firstChild);

            // Add token ID to displayedTokens set
            displayedTokens.add(token.id);
            getCountByNameAndValue(`count_${token.mint}_name`, 'name', token.name);
            getCountByNameAndValue(`count_${token.mint}_symbol`, 'symbol', token.symbol);
            getCountByNameAndValue(`count_${token.mint}_twitter`, 'twitter', token.twitter);
            getCountByNameAndValue(`count_${token.mint}_telegram`, 'telegram', token.telegram);
            getCountByNameAndValue(`count_${token.mint}_creator`, 'creator', token.creator);
            getCountByNameAndValue(`count_${token.mint}_website`, 'website', token.website);
            getCountByNameAndValue(`count_${token.mint}_image_uri`, 'image_uri', token.image_uri);
            getCountBundleTrans(`count_${token.mint}_bundle`, token.mint);
            getCreatorBalance(`count_${token.mint}_creatorbalance`, token.creator);
          }
        });
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
  }

  function getCountBundleTrans(elementId, mintToken) {
  // Construct the URL with the mintToken parameter
  const url = `https://sel.pumpfunclub.com/bundlecheckerview/?&ca_address=${mintToken}`;

  // Perform the fetch operation
  const timeout = 20000; // 10 seconds

// Perform the fetch operation
  fetch(url, { timeout: timeout })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      // Update the count on the page
      const countElement = document.getElementById(elementId);
      if (countElement) {
        countElement.textContent = data.number_of_transactions;
      } else {
        console.error(`Element with id ${elementId} not found.`);
      }
    })
    .catch(error => {
      console.error('Error fetching bundle transaction count:', error);
    });
}

function getCreatorBalance(elementId, mintAddress) {
  // Construct the URL with the mintToken parameter
  const url = `https://sel.pumpfunclub.com/get_wallet_balance/?&wallet_address=${mintAddress}`;

  // Perform the fetch operation
  const timeout = 15000; // 10 seconds

// Perform the fetch operation
  fetch(url, { timeout: timeout })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      // Update the count on the page
      const countElement = document.getElementById(elementId);
      if (countElement) {
        countElement.textContent = data.number_of_transactions;
      } else {
        console.error(`Element with id ${elementId} not found.`);
      }
    })
    .catch(error => {
      console.error('Error fetching bundle transaction count:', error);
    });
}
  // Call fetchAndUpdateData initially
  window.addEventListener('load', fetchAndUpdateData);

  // Set interval to fetch data every 3 seconds
  setInterval(fetchAndUpdateData, 3000); // 3000 milliseconds = 3 seconds
</script>

<!-- Displaying JSON data -->
<section class="py-0">
  <div class="container-fluid">
<div class="row justify-content-center mt-3">
      <div class="col-md-12 text-center">
        <a href="https://x.com/pumpfunclubsol"><img src="/static/images/placeadhere.png" class="img-fluid" /></a>
      </div>
  </div> 
    <div class="row justify-content-center mt-3">
      <div class="col-md-12 text-center">
        The official Pump Fun Club Solana wallet address: 8Tv4jM2MvNrCvRTFTK2DjYJ49fBhwuknJzJNjGKdNKzt  
        <BR>
        <div id="walletAddress"></div>  
        <BR>
        <button id="connectButton">Connect to Phantom</button> 
      </div>
    </div>    
    <div class="row justify-content-center mt-3"> 
      <div class="col-md-12 text-center">
        We have recorded <B><span id="totalTokenCount">{{ total_token_count }}</span></B> tokens from Pump.Fun launches in our database, helping you find the next gem that does 100x.
      </div>
    </div>
    <div class="row justify-content-center mt-3">
      <div class="col-md-12 text-center">
        <form action="/marketcap_async_search/" method="get" class="form-inline justify-content-center">
          <div class="form-group mx-2">
            <label for="search_value" class="mr-2">Search</label>
            <input type="text" class="form-control" id="search_value" name="search_value" required>
          </div>
          <button type="submit" class="btn btn-primary">Go</button>
        </form>
      </div>
    </div>
    <div id="tokenList" class="row mt-3">
      <!-- Tokens will be populated here -->
      <div id="loadingGif" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <img src="https://pumpfunclub.com/static/images/loading.large.gif" alt="Loading Image" style="width: 80%;" />
      </div>
    </div>
  </div>
</section>
<script>
  function getCountByNameAndValue(id, name, value) {
    // Define the base URL
    const baseURL = "/get_count/";

    const encodedName = encodeURIComponent(name);
    const encodedValue = encodeURIComponent(value);

    const url = `${baseURL}?column_name=${encodedName}&value=${encodedValue}`;
      
  
    // Make a GET request to the constructed URL
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Extract the occurrences count from the response data
        const occurrences = data.occurrences;
        
        // Update the content of the dynamically created span element with the count
        document.getElementById(id).textContent = `${occurrences}`;
        let element = document.getElementById(id);
        if (occurrences > 1) {
          element.style.color = 'red';
        } else {
          element.style.color = 'green';
        }        
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
  }
</script>
 
<script>
    document.getElementById('connectButton').addEventListener('click', async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          // Connect to Phantom wallet
          const response = await window.solana.connect();
          console.log('Connected to Phantom wallet');

          // Update the page with the connected wallet address
          document.getElementById('walletAddress').textContent = `Connected wallet: ${response.publicKey.toString()}`;

        } catch (error) {
          console.error('Error connecting to Phantom wallet:', error);
        }
      } else {
        alert('Phantom wallet not found');
      }
    });

   
</script>
{% endblock %}
