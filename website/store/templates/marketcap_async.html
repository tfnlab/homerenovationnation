{% extends 'base.html' %}

{% load custom_filters %}

{% block content %}
<script>
  // Variable to keep track of displayed tokens
  let displayedTokens = new Set();

  // Function to fetch and update data every 3 seconds
  function fetchAndUpdateData() {
    // Define the URL to fetch data from
    const url = "/marketcap_json/";

    // Make a GET request to fetch data
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Fetched data:', data); // Log fetched data for debugging

        // Update token count
        document.getElementById('totalTokenCount').textContent = data.total_token_count;

        // Iterate over each token and append new tokens at the top
        data.tokens.reverse().forEach(token => { // Reverse the array to prepend in order
          // Check if token ID is not in displayedTokens set
          if (!displayedTokens.has(token.id)) {
            const tokenListElement = document.getElementById('tokenList');

            const tokenItem = document.createElement('div');
            tokenItem.className = 'col-md-4 token-item';
            tokenItem.innerHTML = `
              <div class="card">
                <div class="card-body"> 
                  <div>${token.mint}</div>
                  <div>Name: 
                  <a href="javascript:void(0);" onclick="window.open(\'https://www.pump.fun/{{ item.mint }}\', \'newwindow\', \'width=1200, height=2100\'); return false;">${token.name}</a>
                           
                  (<span id="count_${token.mint}_name" onclick="getCountByNameAndValue(this.id, \\'creator\\', \\'${token.name}\\')">-</span>)
                  </div>
                  <div>Symbol: ${token.symbol}
                    (<span id="count_${token.mint}_symbol" onclick="getCountByNameAndValue(this.id, \\'symbol\\', \\'${token.symbol}\\')">-</span>)
                  </div>
                  
                  <div>Image URI: 
                    (<span id="count_${token.mint}_image_uri" onclick="getCountByNameAndValue(this.id, \\'image_uri\\', \\'${token.image_uri}\\')">-</span>)
                    <img src="${token.image_uri}" alt="${token.name}" style="width: 100%;"></div>
                  <div>Twitter: ${token.twitter}
                    (<span id="count_${token.mint}_twitter" onclick="getCountByNameAndValue(this.id, \\'twitter\\', \\'${token.twitter}\\')">-</span>)
  
                  </div>
                  <div>Telegram: ${token.telegram}
                  (<span id="count_${token.mint}_telegram" onclick="getCountByNameAndValue(this.id, \\'telegram\\', \\'${token.telegram}\\')">-</span>)
                  </div>
                  <div>Creator: ${token.creator}
                  (<span id="count_${token.mint}_creator" onclick="getCountByNameAndValue(this.id, \\'creator\\', \\'${token.creator}\\')">-</span>)
                  </div>
                  <div>Website: <a href="${token.website}" target="_blank">${token.website}</a>
                  (<span id="count_${token.mint}_website" onclick="getCountByNameAndValue(this.id, \\'website\\', \\'${token.website}\\')">-</span>)
                  </div>
                </div>
              </div>
            `;

            // Prepend token item to tokenListElement
            tokenListElement.insertBefore(tokenItem, tokenListElement.firstChild);

            // Add token ID to displayedTokens set
            displayedTokens.add(token.id);
            getCountByNameAndValue(`count_${token.mint}_name`, 'name', token.name);
            getCountByNameAndValue(`count_${token.mint}_symbol`, 'symbol', token.symbol);
            getCountByNameAndValue(`count_${token.mint}_twitter`, 'twitter', token.twitter);
            getCountByNameAndValue(`count_${token.mint}_telegram`, 'telegram', token.telegram);
            getCountByNameAndValue(`count_${token.mint}_creator`, 'creator', token.creator);
            getCountByNameAndValue(`count_${token.mint}_website`, 'website', token.website);
            getCountByNameAndValue(`count_${token.mint}_image_uri`, 'image_uri', token.image_uri);
          }
        });
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
  }

  // Call fetchAndUpdateData initially
  window.addEventListener('load', fetchAndUpdateData);

  // Set interval to fetch data every 3 seconds
  setInterval(fetchAndUpdateData, 3000); // 3000 milliseconds = 3 seconds
</script>

<!-- Displaying JSON data -->
<section class="py-0">
  <div class="container-fluid">
    <div class="row mt-3">
      <div class="col-md-12">
        The official Pump Fun Club Solana wallet adress: 8Tv4jM2MvNrCvRTFTK2DjYJ49fBhwuknJzJNjGKdNKzt  
      </div>
    </div>    
    <div class="row mt-3"> 
      <div class="col-md-12">
        We have recorded <span id="totalTokenCount">{{ total_token_count }}</span> tokens from Pump Fun launches in our database for use in our analytics.
      </div>
    </div>
    <div id="tokenList" class="row mt-3">
      <!-- Tokens will be populated here -->
    </div>
  </div>
</section>
<script>
  function getCountByNameAndValue(id, name, value) {
    // Define the base URL
    const baseURL = "/get_count/";
  
    // Construct the complete URL with provided name and value
    const url = `${baseURL}?column_name=${name}&value=${value}`;
  
    // Make a GET request to the constructed URL
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Extract the occurrences count from the response data
        const occurrences = data.occurrences;
        
        // Update the content of the dynamically created span element with the count
        document.getElementById(id).textContent = `${occurrences}`;
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
  }
  </script>
{% endblock %}
